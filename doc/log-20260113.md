# Annoti Bug-Fix 日志

本文档记录 Annoti 项目开发过程中修复的 Bug，按时间顺序整理。

---

## 日志格式

每条 Bug 记录包含以下字段：

| 字段 | 说明 |
|------|------|
| ID | 唯一标识符 |
| 标题 | 简短的 Bug 描述 |
| 描述 | 详细的问题说明 |
| 原因 | 根本原因分析 |
| 影响 | 受影响的范围 |
| 修复 | 解决方案 |
| 状态 | 已修复/待处理 |
| 日期 | 发现/修复日期 |

---

## Bug 列表

### BUG-001: 拖动时便签位置跳变

| 字段 | 内容 |
|------|------|
| **ID** | BUG-001 |
| **标题** | 拖动时便签位置跳变 |
| **描述** | 用户拖动便签时，便签会瞬间跳到错误位置，然后才能正常跟随鼠标移动。 |
| **原因** | 使用 `overlayRect.left` 计算偏移量。当鼠标移动时，overlay 的位置会随拖动改变，导致计算的偏移量不稳定。 |
| **影响** | 便签拖动体验极差，几乎无法正常使用。 |
| **修复** | 改用差值法（delta approach）:<br>1. 记录初始鼠标位置和初始便签位置<br>2. 拖动时计算差值：`offsetX = currentMouseX - initialMouseX`<br>3. 新位置 = 初始便签位置 + 差值 |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/components/StickyNote.vue:70-99` |

**修复前代码:**
```typescript
const onDrag = (e: MouseEvent) => {
    const overlayRect = overlayRef.value?.getBoundingClientRect();
    const newX = e.clientX - overlayRect.left;
    const newY = e.clientY - overlayRect.top;
    // 问题: overlayRect 会随拖动变化
};
```

**修复后代码:**
```typescript
const startDrag = (e: MouseEvent) => {
    initialMouseX = e.clientX;
    initialMouseY = e.clientY;
    initialContentX = props.annotation.notePosition.x;
    initialContentY = props.annotation.notePosition.y;
};

const onDrag = (e: MouseEvent) => {
    const offsetX = e.clientX - initialMouseX;
    const offsetY = e.clientY - initialMouseY;
    const newX = initialContentX + offsetX;
    const newY = initialContentY + offsetY;
    // 正确: 使用差值，不依赖动态 DOM 位置
};
```

---

### BUG-002: Snap-back 便签位置错误

| 字段 | 内容 |
|------|------|
| **ID** | BUG-002 |
| **标题** | Snap-back 唤醒便签时位置错误 |
| **描述** | 点击高亮批注唤醒便签时，便签显示在错误位置，不是预期的点击位置附近。 |
| **原因** | 使用了高亮元素的 `highlightRect.right` 计算位置，而非实际点击事件的 `clientX/clientY`。 |
| **影响** | 便签唤醒位置不可预测，用户体验差。 |
| **修复** | 直接传递点击事件的坐标:<br>`emit("wakeNote", { annotationId, clickX: e.clientX, clickY: e.clientY });` |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/components/DocumentViewer.vue:146-149` |

---

### BUG-003: Y 坐标在滚动后错位

| 字段 | 内容 |
|------|------|
| **ID** | BUG-003 |
| **标题** | 滚动页面后便签 Y 坐标错位 |
| **描述** | 当文档滚动后，点击高亮唤醒便签，Y 坐标计算错误，便签显示在视口外。 |
| **原因** | 公式错误地减去了 `overlayRect.top`，而应该使用 `scrollTop` 进行补偿。 |
| **影响** | 带滚动条的长文档中便签位置完全错误。 |
| **修复** | 修正坐标公式:<br>`const y = clickY - viewerRect.top + viewerPane.scrollTop + offsetY;` |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/components/MainLayout.vue:39-67` |

**坐标转换说明:**
```
视口坐标 (clientY)                    ← 用户看到的点击位置
    │
    ├── viewerRect.top (容器顶部到视口)  ← 需要减去
    │
    ├ viewerPane.scrollTop (滚动距离)  ← 需要加上
    │
    └── 内容坐标                        ← 便签的实际位置
```

---

### BUG-004: 拖动时 X 轴超出边界

| 字段 | 内容 |
|------|------|
| **ID** | BUG-004 |
| **标题** | 便签拖动时 X 轴超出可视区域 |
| **描述** | 拖动便签到屏幕右侧时，便签会完全移出可视区域，无法看到。 |
| **原因** | 拖动逻辑没有对 X 轴进行边界约束。 |
| **影响** | 便签可能拖动到屏幕外，难以找回。 |
| **修复** | 添加 X 轴边界约束:<br>`const maxX = overlayRect.width - noteWidth;`<br>`const constrainedX = Math.max(0, Math.min(newX, maxX));` |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/components/StickyNote.vue:92-98` |

---

### BUG-005: 频繁写入磁盘导致性能问题

| 字段 | 内容 |
|------|------|
| **ID** | BUG-005 |
| **标题** | 频繁写入磁盘导致性能问题 |
| **描述** | 拖动便签时每帧都保存到磁盘，导致严重的性能问题。 |
| **原因** | 没有任何防抖机制，每次状态变更立即触发保存。 |
| **影响** | 拖动卡顿，CPU 和磁盘 IO 占用高。 |
| **修复** | 实现 500ms 防抖机制:<br>`saveTimeout = setTimeout(async () => { ... }, 500);`<br>重复触发时清除旧计时器。 |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/composables/useAnnotations.ts:8-54` |

**防抖流程:**
```
拖动事件 ──┬── 清除旧计时器 ──┬── 设置新计时器 (500ms)
           │                  │
拖动事件 ──┤                  └── (等待 500ms)
           │
... (无新事件 500ms)
           │
           └──→ 执行实际保存
```

---

### BUG-006: 事件监听器内存泄漏

| 字段 | 内容 |
|------|------|
| **ID** | BUG-006 |
| **标题** | 便签组件卸载后事件监听器泄漏 |
| **描述** | 切换文档后，旧便签的 mousemove/mouseup 事件监听器仍在工作。 |
| **原因** | `onUnmounted` 生命周期钩子中没有移除事件监听器。 |
| **影响** | 内存泄漏，切换文档次数多了会导致性能下降。 |
| **修复** | 在 `onUnmounted` 中清理事件监听器。 |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/components/StickyNote.vue:119-131` |

**修复代码:**
```typescript
onUnmounted(() => {
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
    if (resizeMoveHandler.value) {
        document.removeEventListener('mousemove', resizeMoveHandler.value);
    }
    if (resizeStopHandler.value) {
        document.removeEventListener('mouseup', resizeStopHandler.value);
    }
});
```

---

### BUG-007: 导入时时间戳类型不匹配

| 字段 | 内容 |
|------|------|
| **ID** | BUG-007 |
| **标题** | 导入批注时 exported_at 字段类型不匹配 |
| **描述** | 导入 .annpkg 文件时，解析 JSON 失败，提示 exported_at 字段类型错误。 |
| **原因** | 前端使用 `Date.now()` 生成毫秒级时间戳，Rust 后端期望毫秒但导入时解析方式有差异。 |
| **影响** | 无法导入带有时间戳的批注文件。 |
| **修复** | 统一使用毫秒级时间戳，前端生成时间戳时使用 `Date.now()`。 |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src-tauri/src/db.rs:474-501` |

---

### BUG-008: HTML 导出缺少高亮样式

| 字段 | 内容 |
|------|------|
| **ID** | BUG-008 |
| **标题** | HTML 导出后高亮不显示 |
| **描述** | 使用"导出为 HTML"功能后，生成的文件中没有高亮效果。 |
| **原因** | `marked` 渲染时没有添加 `.markdown-body` 包装器，导致 CSS 选择器 `.markdown-body .doc-highlight` 无法匹配。 |
| **影响** | 导出的 HTML 无法正确显示高亮。 |
| **修复** | 在渲染 HTML 时添加包装元素:<br>`const html = marked(`<div class="markdown-body">${content}</div>`);` |
| **状态** | 已修复 |
| **日期** | 2026-01-12 |
| **代码位置** | `src/composables/useAnnotations.ts:296-348` |

---

### BUG-009: 生产构建主题不生效

| 字段 | 内容 |
|------|------|
| **ID** | BUG-009 |
| **标题** | 生产构建中亮色/暗色主题切换失效 |
| **描述** | 在开发环境 (`pnpm tauri dev`) 主题切换正常，但打包后 (`pnpm tauri build`) 主题不生效。 |
| **原因** | CSS 变量定义在非 `:root` 选择器上，开发环境热更新时能正确加载，但生产构建时样式表加载顺序问题导致 CSS 变量未定义。 |
| **影响** | 生产环境无法切换主题，影响用户体验。 |
| **修复** | 将所有 CSS 变量移到 `:root` 选择器中定义，确保无论 `dark-theme` 或 `light-theme` 类是否存在，基础变量都可用。 |
| **状态** | 已修复 |
| **日期** | 2026-01-13 |
| **代码位置** | `src/styles/theme-dark.css`, `src/styles/theme-light.css` |

**修复前:**
```css
.dark-theme {
    --bg-primary: #1a1a1a;
    /* 问题: 如果 .dark-theme 类没加上，这些变量未定义 */
}
```

**修复后:**
```css
:root,
.light-theme {
    --bg-primary: #ffffff;
    --text-primary: #333333;
}

.dark-theme {
    --bg-primary: #1a1a1a;
    --text-primary: #e0e0e0;
}
```

---

## 修复统计

| 分类 | 数量 |
|------|------|
| 已修复 | 9 |
| 待处理 | 0 |
| 总计 | 9 |

### 按模块分类

| 模块 | 数量 |
|------|------|
| 便签系统 | 4 |
| 数据持久化 | 2 |
| 导入导出 | 1 |
| 主题系统 | 1 |
| 性能优化 | 1 |

### 按严重程度分类

| 严重程度 | 数量 | 示例 |
|----------|------|------|
| 严重 | 2 | BUG-001, BUG-005 |
| 中等 | 4 | BUG-002, BUG-003, BUG-004, BUG-009 |
| 轻微 | 3 | BUG-006, BUG-007, BUG-008 |

---

## 经验总结

### 常见错误模式

1. **DOM 坐标依赖**: 不要在拖动计算中依赖会变化的 DOM 位置（如 `getBoundingClientRect()`），使用差值法更稳定。

2. **坐标系统混淆**: 视口坐标和内容坐标是两个系统，滚动时需要正确转换。

3. **事件清理**: Vue 组件卸载时必须清理事件监听器，防止内存泄漏。

4. **性能优化**: 频繁操作（拖动、输入）需要防抖处理。

5. **CSS 变量作用域**: 确保 CSS 变量在 `:root` 定义，有回退值。

### 调试技巧

| 技巧 | 说明 |
|------|------|
| 控制台日志 | 输出坐标值验证计算是否正确 |
| DevTools | 使用 Elements 面板查看 DOM 位置 |
| 断点调试 | 在 mousemove 中设置断点检查值 |
| 视觉标记 | 临时给元素添加 border 观察位置 |

---

*文档创建日期: 2026-01-13*
*最后更新: 2026-01-13*
